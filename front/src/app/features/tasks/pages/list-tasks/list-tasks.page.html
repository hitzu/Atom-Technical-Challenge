<h2 class="mb-2">Listar tareas</h2>

<div
  *ngIf="isLoading()"
  class="alert alert-info"
  role="status"
  aria-live="polite"
>
  Cargando tareas...
</div>

<div *ngIf="errorMessage()" class="alert alert-danger" role="alert">
  {{ errorMessage() }}
</div>

<div class="mb-2">
  <div class="form-check">
    <input
      id="show-completed"
      class="form-check-input"
      type="checkbox"
      [checked]="allTasks()"
      (change)="toggleShowCompleted()"
    />
    <label class="form-check-label" for="show-completed">
      Mostrar completadas
    </label>
  </div>
</div>

<div
  *ngIf="!isLoading() && !errorMessage() && tasks.length === 0"
  class="alert alert-secondary"
  role="status"
>
  No hay tareas para mostrar.
</div>

<div *ngIf="tasks.length > 0" class="table-responsive">
  <table class="table table-striped table-bordered align-middle">
    <caption class="visually-hidden">
      Listado de tareas
    </caption>
    <thead>
      <tr>
        <th scope="col">Título</th>
        <th scope="col">Descripción</th>
        <th
          scope="col"
          class="text-nowrap"
          [attr.aria-sort]="sort() === 'asc' ? 'ascending' : 'descending'"
        >
          <button
            type="button"
            class="btn btn-link p-0 align-baseline text-decoration-none"
            (click)="toggleSort()"
            [attr.aria-label]="'Ordenar por fecha de creación ' + (sort() === 'asc' ? 'descendente' : 'ascendente')"
          >
            Fecha de creación
            <span class="ms-1" aria-hidden="true">
              {{ sort() === 'asc' ? '↑' : '↓' }}
            </span>
          </button>
        </th>
        <th scope="col">Estado</th>
        <th scope="col">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let task of tasks; trackBy: trackByTaskId">
        <td class="text-nowrap">{{ task.title }}</td>
        <td>{{ task.description || '-' }}</td>
        <td class="text-nowrap">
          {{ task.createdAt | date: 'EEEE, MMMM d, y, HH:mm:ss':'':'es-ES' }}
        </td>
        <td>{{ task.completed | yesNo }}</td>
        <td>
          <button
            class="btn btn-primary btn-sm"
            (click)="editTask(task.id || '')"
          >
            Editar
          </button>
          <button
            class="btn btn-danger btn-sm"
            (click)="openDeleteModal(task)"
            [disabled]="isDeleting()"
          >
            Eliminar
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

@if (isDeleteModalOpen()) {
<div
  class="atom-modal-backdrop"
  aria-hidden="true"
  (click)="closeDeleteModal()"
></div>

<div
  class="atom-modal"
  role="dialog"
  aria-modal="true"
  aria-labelledby="delete-modal-title"
  aria-describedby="delete-modal-desc"
  (click)="closeDeleteModal()"
  (keydown)="onDeleteModalKeydown($event)"
>
  <div
    #deleteModalCard
    class="atom-modal__card"
    tabindex="-1"
    (click)="$event.stopPropagation()"
  >
    <h2 id="delete-modal-title" class="atom-modal__title">Eliminar tarea</h2>
    <p id="delete-modal-desc" class="atom-modal__text">
      ¿Seguro que deseas eliminar
      <span class="atom-modal__task-title">
        {{ pendingDeleteTask()?.title }}
      </span>
      ? Esta acción no se puede deshacer.
    </p>

    @if (deleteErrorMessage()) {
    <p class="atom-modal__error" role="alert">{{ deleteErrorMessage() }}</p>
    }

    <div class="atom-modal__actions">
      <button
        type="button"
        class="atom-modal__btn atom-modal__btn--secondary"
        (click)="closeDeleteModal()"
        [disabled]="isDeleting()"
      >
        Cancelar
      </button>

      <button
        type="button"
        class="atom-modal__btn atom-modal__btn--danger"
        (click)="confirmDelete()"
        [disabled]="isDeleting()"
      >
        {{ isDeleting() ? 'Eliminando...' : 'Eliminar' }}
      </button>
    </div>
  </div>
</div>
}
